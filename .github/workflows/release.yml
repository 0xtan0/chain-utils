name: Release

on:
    push:
        branches:
            - main

concurrency:
    group: ${{github.workflow}}-${{github.ref}}
    cancel-in-progress: true

permissions:
    contents: write
    pull-requests: write
    id-token: write

jobs:
    build:
        uses: ./.github/workflows/build.yml

    lint:
        uses: ./.github/workflows/lint.yml
        needs: build

    test:
        uses: ./.github/workflows/test.yml
        needs: lint

    test-integration:
        uses: ./.github/workflows/test-integration.yml
        needs: lint

    release:
        name: Version
        needs: [test, test-integration]
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        outputs:
            should-publish: ${{steps.changesets.outputs.hasChangesets == 'false'}}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup environment
              uses: ./.github/actions/setup

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build

            - name: Create Release PR
              id: changesets
              uses: changesets/action@v1
              with:
                  version: pnpm changeset:version
                  title: "chore: version packages"
                  commit: "chore: version packages"
              env:
                  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

            - name: Add RELEASE label to PR
              if: steps.changesets.outputs.pullRequestNumber
              run: gh pr edit ${{steps.changesets.outputs.pullRequestNumber}} --add-label "RELEASE"
              env:
                  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    publish:
        name: Publish to npm
        needs: release
        if: needs.release.outputs.should-publish == 'true'
        runs-on: ubuntu-latest
        environment: publisher
        permissions:
            contents: write
            id-token: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
                  registry-url: "https://registry.npmjs.org"

            - name: Upgrade npm for OIDC support
              run: npm install -g npm@latest

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build

            - name: Publish
              run: pnpm changeset publish
              env:
                  NPM_CONFIG_PROVENANCE: "true"

            - name: Create git tags
              run: |
                  for pkg in packages/*/package.json; do
                      NAME=$(node -e "console.log(require('./$pkg').name.replace('@0xtan0/chain-utils-', ''))")
                      VERSION=$(node -e "console.log(require('./$pkg').version)")
                      TAG="${NAME}-${VERSION}"

                      if git rev-parse "$TAG" >/dev/null 2>&1; then
                          echo "Tag $TAG already exists, skipping"
                      else
                          git tag "$TAG"
                          echo "Created tag $TAG"
                      fi
                  done

                  git push origin --tags

                  echo "### Tags pushed" >> "$GITHUB_STEP_SUMMARY"
                  git tag --points-at HEAD | while read -r tag; do
                      echo "- \`$tag\`" >> "$GITHUB_STEP_SUMMARY"
                  done
