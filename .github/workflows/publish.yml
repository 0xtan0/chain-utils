name: Publish to npm

on:
    workflow_call:
        inputs:
            release-type:
                description: 'Type of release: "release" or "canary"'
                required: true
                type: string

permissions:
    contents: write
    id-token: write

jobs:
    publish:
        name: Publish (${{inputs.release-type}})
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup environment
              uses: ./.github/actions/setup

            - name: Install npm
              run: npm install -g npm@11.7.0

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build

            - name: Publish release
              if: inputs.release-type == 'release'
              run: pnpm changeset publish

            - name: Create git tags
              if: inputs.release-type == 'release'
              run: |
                  for pkg in packages/*/package.json; do
                      NAME=$(node -e "console.log(require('./$pkg').name.replace('@0xtan0/chain-utils-', ''))")
                      VERSION=$(node -e "console.log(require('./$pkg').version)")
                      TAG="${NAME}-${VERSION}"

                      if git rev-parse "$TAG" >/dev/null 2>&1; then
                          echo "Tag $TAG already exists, skipping"
                      else
                          git tag "$TAG"
                          echo "Created tag $TAG"
                      fi
                  done

                  git push origin --tags

                  echo "### Tags pushed" >> "$GITHUB_STEP_SUMMARY"
                  git tag --points-at HEAD | while read -r tag; do
                      echo "- \`$tag\`" >> "$GITHUB_STEP_SUMMARY"
                  done

            - name: Set canary versions
              if: inputs.release-type == 'canary'
              run: |
                  SHORT_HASH=$(git rev-parse --short HEAD)
                  pnpm changeset version --snapshot "canary-${SHORT_HASH}"

            - name: Publish canary
              if: inputs.release-type == 'canary'
              run: pnpm changeset publish --tag canary --no-git-tag
